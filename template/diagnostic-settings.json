{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.1",
  "parameters": {
    "resourceId": {
      "type": "string",
      "metadata": {
        "displayName": "Resource ID",
        "description": "Resource ID for the resource to which the Diagnostics setting will be added"
      }
    },
    "diagnosticsSettingName": {
      "type": "string"
    },
    "logAnalyticsWorkspaceResourceId": {
      "type": "string"
    },
    "storageAccountResourceId": {
      "type": "string"
    },
    "sendAllLogs": {
      "type": "bool",
      "defaultValue": true
    },
    "sendAuditLogs": {
      "type": "bool",
      "defaultValue": false
    },
    "sendMetrics": {
      "type": "bool",
      "defaultValue": true
    }
  },
  "variables": {
    "workspaceId": "[if(parameters('logAnalyticsWorkspaceResourceId'), parameters('logAnalyticsWorkspaceResourceId'), json('null'))]",
    "storageAccountId": "[if(parameters('storageAccountResourceId'), parameters('storageAccountResourceId'), json('null'))]",
    "allLogs": "[if( equals(true(), bool(parameters('sendAllLogs'))), array(createObject('categoryGroup', 'allLogs', 'enabled', 'true')), json('[]') )]",
    "auditLogs": "[if( equals(true(), bool(parameters('sendAuditLogs'))), array(createObject('categoryGroup', 'allLogs', 'enabled', 'true')), json('[]') )]",
    "logs": "[union(variables('allLogs'), variables('auditLogs'))]",
    "metrics": "[if( equals(true(), bool(parameters('sendMetrics'))), array(createObject('category', 'AllMetrics', 'timeGrain', 'PT1M', 'enabled', 'true', 'retentionPolicy', createObject('enabled', 'false', 'days', 0))), json('[]') )]",
    "apiVersionDiagnostics": "2021-05-01-preview"
  },
  "resources": [
    {
      "name": "[parameters('diagnosticsSettingName')]",
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "[variables('apiVersionDiagnostics')]",
      "scope": "[parameters('resourceId')]",
      "properties": {
        "workspaceId": "[variables('workspaceId')]",
        "storageAccountId": "[variables('storageAccountId')]",
        "metrics": "[variables('metrics')]",
        "logs": "[variables('logs')]"
      }
    }
  ]
}